const express = require("express");
const router = express.Router();
const pool = require("../config/pool");
const bcrypt = require("bcryptjs"); // Para criptografar senhas
const crypto = require("crypto");    // Para gerar tokens aleat√≥rios
const nodemailer = require("nodemailer"); // Enviar email de recupera√ß√£o

// Vari√°veis de ambiente ou fallback
const EMAIL_USER = process.env.EMAIL_USER || "seuemail@gmail.com";
const EMAIL_PASS = process.env.EMAIL_PASS || "suasenha";

// üß™ Fun√ß√£o que valida se todos os campos obrigat√≥rios foram preenchidos
const validarCampos = ({ nome, email, senha, endereco, data_nascimento, telefone, pais, estado, cidade, cep, ponto_referencia }) => {
  return nome && email && senha && endereco && data_nascimento && telefone && pais && estado && cidade && cep && ponto_referencia;
};

// üîê Fun√ß√£o utilit√°ria para gerar token seguro
const generateToken = () => crypto.randomBytes(32).toString("hex");

// ‚úÖ POST /register ‚Äî Cadastro de novo usu√°rio
router.post("/register", async (req, res) => {
  const { nome, email, senha, endereco, data_nascimento, telefone, pais, estado, cidade, cep, ponto_referencia } = req.body;

  if (!validarCampos(req.body)) {
    return res.status(400).json({ mensagem: "Todos os campos s√£o obrigat√≥rios." });
  }

  try {
    // Verifica se e-mail j√° est√° cadastrado
    const [rows] = await pool.execute("SELECT id FROM usuarios WHERE email = ?", [email]);
    if (rows.length > 0) {
      return res.status(400).json({ mensagem: "Esse e-mail j√° est√° cadastrado. Tente outro ou fa√ßa login." });
    }

    // Criptografa a senha antes de salvar
    const senhaHash = await bcrypt.hash(senha, 10);

    // Insere o novo usu√°rio
    await pool.execute(`
      INSERT INTO usuarios (nome, email, senha, endereco, data_nascimento, telefone, pais, estado, cidade, cep, ponto_referencia)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `, [nome, email, senhaHash, endereco, data_nascimento, telefone, pais, estado, cidade, cep, ponto_referencia]);

    res.status(201).json({ mensagem: "Usu√°rio cadastrado com sucesso!" });
  } catch (error) {
    console.error("Erro ao cadastrar usu√°rio:", error);
    res.status(500).json({ mensagem: "Erro no servidor. Tente novamente mais tarde." });
  }
});

// ‚úÖ POST /forgot-password ‚Äî Enviar link de redefini√ß√£o de senha
router.post("/forgot-password", async (req, res) => {
  try {
    const { email } = req.body;

    const [rows] = await pool.execute("SELECT id FROM usuarios WHERE email = ?", [email]);
    if (!rows || rows.length === 0) {
      return res.status(200).json({
        mensagem: "Se este e-mail estiver cadastrado, enviaremos um link para redefinir a senha."
      });
    }

    const user = rows[0];
    const token = generateToken(); // Gera um token √∫nico
    const expires = new Date(Date.now() + 3600000); // Expira em 1h

    // Salva o token no banco com data de validade
    await pool.execute(
      "UPDATE usuarios SET resetToken = ?, resetTokenExpires = ? WHERE id = ?",
      [token, expires, user.id]
    );

    const transporter = nodemailer.createTransport({
      service: "Gmail",
      auth: {
        user: EMAIL_USER,
        pass: EMAIL_PASS,
      },
    });

    const resetLink = `http://localhost:3000/reset-password?token=${token}`; // Link para o frontend

    // Envia e-mail de recupera√ß√£o
    await transporter.sendMail({
      from: `"Suporte" <${EMAIL_USER}>`,
      to: email,
      subject: "Redefini√ß√£o de Senha",
      html: `
        <p>Voc√™ solicitou a redefini√ß√£o de senha.</p>
        <p>Clique aqui para redefinir: <a href="${resetLink}">${resetLink}</a></p>
        <p>Se voc√™ n√£o solicitou isso, ignore este e-mail.</p>
      `,
    });

    return res.status(200).json({
      mensagem: "Se este e-mail estiver cadastrado, enviaremos um link para redefinir a senha."
    });
  } catch (error) {
    console.error("Erro em forgot-password:", error);
    return res.status(500).json({ mensagem: "Erro no servidor. Tente novamente mais tarde." });
  }
});

// ‚úÖ POST /reset-password ‚Äî Redefinir a senha com token
router.post("/reset-password", async (req, res) => {
  try {
    const { token, novaSenha } = req.body;

    const [rows] = await pool.execute(
      "SELECT id FROM usuarios WHERE resetToken = ? AND resetTokenExpires > NOW()",
      [token]
    );

    if (!rows || rows.length === 0) {
      return res.status(400).json({ mensagem: "Token inv√°lido ou expirado." });
    }

    const user = rows[0];
    const novaSenhaHash = await bcrypt.hash(novaSenha, 10);

    await pool.execute(
      "UPDATE usuarios SET senha = ?, resetToken = NULL, resetTokenExpires = NULL WHERE id = ?",
      [novaSenhaHash, user.id]
    );

    return res.status(200).json({ mensagem: "Senha redefinida com sucesso!" });
  } catch (error) {
    console.error("Erro em reset-password:", error);
    return res.status(500).json({ mensagem: "Erro no servidor. Tente novamente mais tarde." });
  }
});

module.exports = router;
