const express = require("express");
const pool = require("../config/pool"); // Conex√£o com o banco de dados MySQL
const axios = require("axios"); // Pode ser usado para enviar mensagens no WhatsApp
const router = express.Router();

// üì¶ POST /api/checkout ‚Äî Registra um novo pedido no banco
router.post("/", async (req, res) => {
  console.log("üîî [POST] /api/checkout foi acionada!");

  // Desestrutura os dados esperados no corpo da requisi√ß√£o
  const {
    usuario_id,        // ID do usu√°rio que est√° fazendo o pedido
    endereco,          // Objeto contendo logradouro, cidade, n√∫mero, etc.
    formaPagamento,    // Exemplo: "Pix", "Cart√£o", "Dinheiro"
    produtos,          // Lista de produtos comprados com quantidade
  } = req.body;

  // Valida se todos os campos obrigat√≥rios foram enviados
  if (!usuario_id || !endereco || !formaPagamento || !produtos) {
    console.warn("‚ö†Ô∏è Campos obrigat√≥rios ausentes no corpo da requisi√ß√£o.");
    return res.status(400).json({ message: "Todos os campos s√£o obrigat√≥rios" });
  }

  const connection = await pool.getConnection(); // Pega uma conex√£o do pool

  try {
    await connection.beginTransaction(); // Inicia transa√ß√£o para garantir integridade do pedido

    // üî∏ Insere o pedido na tabela principal
    const [pedidoResult] = await connection.query(
      "INSERT INTO pedidos (usuario_id, endereco, forma_pagamento) VALUES (?, ?, ?)",
      [usuario_id, JSON.stringify(endereco), formaPagamento]
    );

    const pedidoId = pedidoResult.insertId; // Pega o ID do pedido rec√©m-criado

    // üî∏ Insere os itens do pedido na tabela de liga√ß√£o pedidos_produtos
    for (const produto of produtos) {
      await connection.query(
        "INSERT INTO pedidos_produtos (pedido_id, produto_id, quantidade) VALUES (?, ?, ?)",
        [pedidoId, produto.id, produto.quantidade]
      );
    }

    await connection.commit(); // Finaliza a transa√ß√£o com sucesso
    console.log(`‚úÖ Pedido #${pedidoId} salvo com sucesso no banco de dados!`);

    // üí¨ Mensagem de confirma√ß√£o (opcional: envio para WhatsApp)
    const mensagem = `üì¶ *Novo Pedido Confirmado!* \n\nüõí Pedido ID: ${pedidoId}\nüìç Endere√ßo: ${endereco.logradouro}, ${endereco.numero} - ${endereco.cidade}\nüí≥ Pagamento: ${formaPagamento}\n\n‚úÖ Seu pedido foi registrado!`;

    // (Comentado) Exemplo de integra√ß√£o com API do WhatsApp:
    /*
    await axios.post("https://api.whatsapp.com/send", {
      to: "+55SEUNUMERO",
      message: mensagem,
    });
    */

    res.status(201).json({ message: "Pedido registrado com sucesso!" });
  } catch (error) {
    await connection.rollback(); // Se algo falhar, desfaz tudo
    console.error("‚ùå Erro ao salvar pedido:", error);
    res.status(500).json({ message: "Erro ao processar o pedido" });
  } finally {
    connection.release(); // Libera a conex√£o para ser usada novamente
  }
});

module.exports = router; // Exporta o roteador para ser usado na aplica√ß√£o principal
