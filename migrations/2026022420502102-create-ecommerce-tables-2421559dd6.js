/* eslint-disable no-unused-vars */
"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.sequelize.transaction(async (t) => {
      await queryInterface.sequelize.query("CREATE TABLE `categories` (\n`id` int NOT NULL AUTO_INCREMENT,\n`name` varchar(100) NOT NULL,\n`slug` varchar(255) NOT NULL,\n`is_active` tinyint(1) NOT NULL DEFAULT '1',\n`sort_order` int NOT NULL DEFAULT '0',\n`description` text,\nPRIMARY KEY (`id`),\nUNIQUE KEY `idx_categories_slug` (`slug`)\n) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `cupons` (\n`id` int unsigned NOT NULL AUTO_INCREMENT,\n`codigo` varchar(50) NOT NULL,\n`tipo` enum('percentual','valor') NOT NULL,\n`valor` decimal(10,2) NOT NULL,\n`minimo` decimal(10,2) DEFAULT '0.00',\n`expiracao` datetime DEFAULT NULL,\n`usos` int unsigned NOT NULL DEFAULT '0',\n`max_usos` int unsigned DEFAULT NULL,\n`ativo` tinyint(1) NOT NULL DEFAULT '1',\nPRIMARY KEY (`id`),\nUNIQUE KEY `codigo` (`codigo`)\n) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `payment_methods` (\n`id` int NOT NULL AUTO_INCREMENT,\n`code` varchar(32) NOT NULL,\n`label` varchar(80) NOT NULL,\n`description` varchar(255) DEFAULT NULL,\n`is_active` tinyint(1) NOT NULL DEFAULT '1',\n`sort_order` int NOT NULL DEFAULT '0',\n`created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n`updated_at` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nUNIQUE KEY `code` (`code`)\n) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `product_categories` (\n`product_id` int NOT NULL AUTO_INCREMENT,\n`category_id` int DEFAULT NULL,\nPRIMARY KEY (`product_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=76 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `usuarios` (\n`id` int NOT NULL AUTO_INCREMENT,\n`nome` varchar(255) NOT NULL,\n`email` varchar(255) NOT NULL,\n`senha` varchar(255) NOT NULL,\n`endereco` varchar(255) DEFAULT NULL,\n`data_nascimento` date DEFAULT NULL,\n`telefone` varchar(20) DEFAULT NULL,\n`cpf` varchar(14) DEFAULT NULL,\n`criado_em` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\n`resetToken` varchar(255) DEFAULT NULL,\n`resetTokenExpires` datetime DEFAULT NULL,\n`pais` varchar(100) DEFAULT NULL,\n`estado` varchar(100) DEFAULT NULL,\n`cidade` varchar(100) DEFAULT NULL,\n`cep` varchar(10) DEFAULT NULL,\n`ponto_referencia` varchar(255) DEFAULT NULL,\n`status_conta` enum('ativo','bloqueado') NOT NULL DEFAULT 'ativo',\nPRIMARY KEY (`id`),\nUNIQUE KEY `email` (`email`),\nUNIQUE KEY `usuarios_cpf_unique` (`cpf`)\n) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `products` (\n`id` int NOT NULL AUTO_INCREMENT,\n`name` varchar(150) NOT NULL DEFAULT '',\n`description` text,\n`price` decimal(10,2) NOT NULL,\n`image` text CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci,\n`rating_avg` decimal(3,2) DEFAULT '0.00',\n`rating_count` int unsigned DEFAULT '0',\n`quantity` int NOT NULL DEFAULT '0',\n`created_at` timestamp NOT NULL DEFAULT (now()),\n`updated_at` timestamp NOT NULL DEFAULT (now()) ON UPDATE CURRENT_TIMESTAMP,\n`category_id` int DEFAULT NULL,\n`sold_count` int unsigned NOT NULL DEFAULT '0',\n`shipping_free` tinyint(1) NOT NULL DEFAULT '0',\n`shipping_free_from_qty` int DEFAULT NULL,\n`shipping_prazo_dias` int DEFAULT NULL COMMENT 'Prazo pr√≥prio do produto (em dias)',\nPRIMARY KEY (`id`),\nKEY `idx_products_category` (`category_id`),\nKEY `idx_products_name` (`name`),\nKEY `idx_products_description` (`description`(100)),\nKEY `idx_products_category_id` (`category_id`),\nKEY `idx_products_price` (`price`),\nKEY `idx_products_created_at` (`created_at`),\nKEY `idx_products_sold_count` (`sold_count`),\nCONSTRAINT `fk_category` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL\n) ENGINE=InnoDB AUTO_INCREMENT=114 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `carrinhos` (\n`id` int NOT NULL AUTO_INCREMENT,\n`usuario_id` int NOT NULL,\n`status` enum('aberto','convertido','cancelado') DEFAULT 'aberto',\n`created_at` datetime DEFAULT CURRENT_TIMESTAMP,\n`updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nKEY `idx_carrinhos_usuario_status_created` (`usuario_id`,`status`,`created_at`),\nCONSTRAINT `carrinhos_ibfk_1` FOREIGN KEY (`usuario_id`) REFERENCES `usuarios` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `enderecos_usuario` (\n`id` int NOT NULL AUTO_INCREMENT,\n`usuario_id` int NOT NULL,\n`apelido` varchar(50) DEFAULT NULL,\n`cep` varchar(20) NOT NULL,\n`endereco` varchar(255) NOT NULL,\n`numero` varchar(20) NOT NULL,\n`bairro` varchar(100) NOT NULL,\n`cidade` varchar(100) NOT NULL,\n`estado` varchar(50) NOT NULL,\n`complemento` varchar(255) DEFAULT NULL,\n`ponto_referencia` varchar(255) DEFAULT NULL,\n`telefone` varchar(20) DEFAULT NULL,\n`is_default` tinyint(1) DEFAULT '0',\n`created_at` datetime DEFAULT CURRENT_TIMESTAMP,\n`updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n`tipo_localidade` enum('URBANA','RURAL') NOT NULL DEFAULT 'URBANA',\n`comunidade` varchar(255) DEFAULT NULL,\n`observacoes_acesso` varchar(255) DEFAULT NULL,\nPRIMARY KEY (`id`),\nKEY `idx_enderecos_usuario_usuario_default` (`usuario_id`,`is_default`),\nKEY `idx_enderecos_usuario_tipo_localidade` (`tipo_localidade`),\nCONSTRAINT `enderecos_usuario_ibfk_1` FOREIGN KEY (`usuario_id`) REFERENCES `usuarios` (`id`) ON DELETE CASCADE,\nCONSTRAINT `chk_enderecos_usuario_rural_required` CHECK (((`tipo_localidade` <> _utf8mb4'RURAL') or ((`comunidade` is not null) and (trim(`comunidade`) <> _utf8mb4'') and (`observacoes_acesso` is not null) and (trim(`observacoes_acesso`) <> _utf8mb4''))))\n) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `pedidos` (\n`id` int NOT NULL AUTO_INCREMENT,\n`usuario_id` int NOT NULL,\n`endereco` text NOT NULL,\n`forma_pagamento` varchar(50) NOT NULL,\n`status_pagamento` enum('pendente','pago','falhou','estornado') DEFAULT 'pendente',\n`status_entrega` enum('em_separacao','processando','enviado','entregue','cancelado') DEFAULT 'em_separacao',\n`data_pedido` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\n`status` varchar(50) DEFAULT 'pendente',\n`total` decimal(10,2) NOT NULL DEFAULT '0.00',\n`pagamento_id` varchar(64) DEFAULT NULL,\n`shipping_price` decimal(10,2) NOT NULL DEFAULT '0.00',\n`shipping_rule_applied` varchar(32) DEFAULT NULL,\n`shipping_prazo_dias` int DEFAULT NULL,\n`shipping_cep` varchar(8) DEFAULT NULL,\nPRIMARY KEY (`id`),\nKEY `usuario_id` (`usuario_id`),\nKEY `idx_pedidos_pagamento` (`pagamento_id`),\nKEY `idx_pedidos_shipping_cep` (`shipping_cep`),\nCONSTRAINT `pedidos_ibfk_1` FOREIGN KEY (`usuario_id`) REFERENCES `usuarios` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=69 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `favorites` (\n`id` int NOT NULL AUTO_INCREMENT,\n`user_id` int NOT NULL,\n`product_id` int NOT NULL,\n`created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nUNIQUE KEY `uniq_user_product` (`user_id`,`product_id`),\nKEY `fk_favorites_product` (`product_id`),\nCONSTRAINT `fk_favorites_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,\nCONSTRAINT `fk_favorites_user` FOREIGN KEY (`user_id`) REFERENCES `usuarios` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `product_images` (\n`id` int NOT NULL AUTO_INCREMENT,\n`product_id` int NOT NULL,\n`path` varchar(255) NOT NULL,\n`created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nKEY `idx_product_images_pid` (`product_id`),\nCONSTRAINT `fk_product_images_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=45 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `product_promotions` (\n`id` int NOT NULL AUTO_INCREMENT,\n`product_id` int NOT NULL,\n`title` varchar(120) DEFAULT NULL,\n`type` enum('PROMOCAO','FLASH') NOT NULL DEFAULT 'PROMOCAO',\n`discount_percent` decimal(5,2) DEFAULT NULL,\n`promo_price` decimal(10,2) DEFAULT NULL,\n`start_at` datetime DEFAULT NULL,\n`end_at` datetime DEFAULT NULL,\n`is_active` tinyint(1) NOT NULL DEFAULT '1',\n`created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nUNIQUE KEY `uq_destaques_product` (`product_id`),\nKEY `idx_promos_active_window` (`is_active`,`start_at`,`end_at`,`product_id`),\nKEY `idx_promos_product_id` (`product_id`,`id`),\nCONSTRAINT `fk_destaques_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,\nCONSTRAINT `product_promotions_ibfk_1` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `produto_avaliacoes` (\n`id` int unsigned NOT NULL AUTO_INCREMENT,\n`produto_id` int NOT NULL,\n`usuario_id` int DEFAULT NULL,\n`nota` tinyint unsigned NOT NULL,\n`comentario` text,\n`created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nKEY `fk_produto_avaliacoes_produto` (`produto_id`),\nKEY `fk_produto_avaliacoes_usuario` (`usuario_id`),\nCONSTRAINT `fk_produto_avaliacoes_produto` FOREIGN KEY (`produto_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,\nCONSTRAINT `fk_produto_avaliacoes_usuario` FOREIGN KEY (`usuario_id`) REFERENCES `usuarios` (`id`) ON DELETE SET NULL\n) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `carrinho_itens` (\n`id` int NOT NULL AUTO_INCREMENT,\n`carrinho_id` int NOT NULL,\n`produto_id` int NOT NULL,\n`quantidade` int NOT NULL,\n`valor_unitario` decimal(10,2) NOT NULL,\n`created_at` datetime DEFAULT CURRENT_TIMESTAMP,\n`updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nKEY `carrinho_id` (`carrinho_id`),\nKEY `produto_id` (`produto_id`),\nCONSTRAINT `carrinho_itens_ibfk_1` FOREIGN KEY (`carrinho_id`) REFERENCES `carrinhos` (`id`) ON DELETE CASCADE,\nCONSTRAINT `carrinho_itens_ibfk_2` FOREIGN KEY (`produto_id`) REFERENCES `products` (`id`) ON DELETE RESTRICT\n) ENGINE=InnoDB AUTO_INCREMENT=74 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `carrinhos_abandonados` (\n`id` int NOT NULL AUTO_INCREMENT,\n`carrinho_id` int NOT NULL,\n`usuario_id` int NOT NULL,\n`itens` json NOT NULL,\n`total_estimado` decimal(10,2) NOT NULL DEFAULT '0.00',\n`criado_em` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n`atualizado_em` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n`recuperado` tinyint(1) NOT NULL DEFAULT '0',\nPRIMARY KEY (`id`),\nUNIQUE KEY `carrinho_id` (`carrinho_id`),\nKEY `idx_carr_aband_usuario_created` (`usuario_id`,`criado_em`),\nKEY `idx_carr_aband_recuperado` (`recuperado`),\nCONSTRAINT `fk_carr_aband_cart` FOREIGN KEY (`carrinho_id`) REFERENCES `carrinhos` (`id`),\nCONSTRAINT `fk_carr_aband_user` FOREIGN KEY (`usuario_id`) REFERENCES `usuarios` (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `pedidos_produtos` (\n`id` int NOT NULL AUTO_INCREMENT,\n`pedido_id` int NOT NULL,\n`produto_id` int NOT NULL,\n`quantidade` int NOT NULL,\n`valor_unitario` decimal(10,2) NOT NULL DEFAULT '0.00',\n`subtotal` decimal(10,2) NOT NULL DEFAULT '0.00',\nPRIMARY KEY (`id`),\nUNIQUE KEY `uniq_pedido_item` (`pedido_id`,`produto_id`),\nKEY `produto_id` (`produto_id`),\nCONSTRAINT `pedidos_produtos_ibfk_1` FOREIGN KEY (`pedido_id`) REFERENCES `pedidos` (`id`) ON DELETE CASCADE,\nCONSTRAINT `pedidos_produtos_ibfk_2` FOREIGN KEY (`produto_id`) REFERENCES `products` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=114 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
      await queryInterface.sequelize.query("CREATE TABLE `carrinhos_abandonados_notifications` (\n`id` int NOT NULL AUTO_INCREMENT,\n`carrinho_abandonado_id` int NOT NULL,\n`tipo` enum('whatsapp','email') NOT NULL,\n`scheduled_at` datetime NOT NULL,\n`sent_at` datetime DEFAULT NULL,\n`status` enum('pending','sent','error','canceled') NOT NULL DEFAULT 'pending',\n`error_message` text,\n`created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n`updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\nPRIMARY KEY (`id`),\nUNIQUE KEY `uniq_cart_tipo_scheduled` (`carrinho_abandonado_id`,`tipo`,`scheduled_at`),\nKEY `idx_status_scheduled` (`status`,`scheduled_at`),\nCONSTRAINT `fk_carrinho_aband_notif` FOREIGN KEY (`carrinho_abandonado_id`) REFERENCES `carrinhos_abandonados` (`id`) ON DELETE CASCADE\n) ENGINE=InnoDB AUTO_INCREMENT=24 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;", { transaction: t });
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.sequelize.transaction(async (t) => {
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `carrinhos_abandonados_notifications`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `pedidos_produtos`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `carrinhos_abandonados`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `carrinho_itens`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `produto_avaliacoes`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `product_promotions`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `product_images`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `favorites`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `pedidos`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `enderecos_usuario`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `carrinhos`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `products`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `usuarios`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `product_categories`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `payment_methods`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `cupons`;", { transaction: t });
      await queryInterface.sequelize.query("DROP TABLE IF EXISTS `categories`;", { transaction: t });
    });
  },
};
